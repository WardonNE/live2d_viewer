<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destiny Child Live2D</title>
</head>
<body>
    <canvas class="live2d-canvas" id="canvas"></canvas>
</body>
</html>
<script>
    let data = {{data}};

    function includeJS(path, onload = () => {}) {
        let script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        script.setAttribute("src", path);
        script.async = false;
        script.onload = onload;
        document.getElementsByTagName('head')[0].appendChild(script);        
    } 

    function init() {
        let canvas = window.document.getElementById('canvas');
        canvas.style.backgroundColor = '#333';
        canvas.width = window.innerWidth * 2;
        canvas.height = window.innerHeight * 2;

        if(data.has_background_image) {
            canvas.style.backgroundImage = `url('http://${data.background_image}')`;
            canvas.style.backgroundRepeat = 'no-repeat';
            canvas.style.backgroundPosition = 'center';
            canvas.style.backgroundSize = 'contain';
        }

        setCanvas('canvas');

        loadLive2d(`http://${data.live2d}`);

        window.animeFrame = function() {
            let animationFrame = window.requestAnimationFrame;
            if (window.Live2D.captureFrame) {
                window.Live2D.captureFrame = false;
                let dataURL = window.canvas.toDataURL("image/jpeg", 1.0);
                let dataURLParts = dataURL.split(",");
                let base64Data = dataURLParts[1];
                let mime = dataURLParts[0].match(/:(.*?);/)[1];
                window.chrome.webview.postMessage(base64Data);
            }
            animationFrame(window.animeFrame);
        }

        window.animeFrame();
    }

    // don't change this function name or delete this function
    // because this function will be called by the application through webview.executeScript
    function setMotion(motion) {
        if(!data.can_set_motion) {
            return;
        }
        let model = window.live2DMgr.getModel(0);
        if(!model) {
            return;
        }
        model.startRandomMotion(motion, window.LAppDefine.PRIORITY_FORCE);
    }

    // don't change this function name or delete this function
    // because this function will be called by the application through webview.executeScript
    function setExpression(expression) {
        if(!data.can_set_expression) {
            return;
        }
        let model = window.live2DMgr.getModel(0);
        if(!model) {
            return;
        }
        model.setExpression(expression);
    }

    

    
    function snapshot() {
        window.Live2D.captureFrame = true;
    }

    window.onload = () => {
        
        let libs = [
            {'href': `http://${data.webview_host}/js/live2d-v2/lib/live2d.min.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/framework/Live2DFramework.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/src/utils/MatrixStack.js`, 'onload': () => {}},  
            {'href': `http://${data.webview_host}/js/live2d-v2/src/utils/ModelSettingJson.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/src/PlatformManager.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/src/LAppDefine.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/src/LAppModel.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/src/LAppLive2DManager.js`, 'onload': () => {}},
            {'href': `http://${data.webview_host}/js/live2d-v2/src/LAppModelLoader.js`, 'onload': init},
        ];
        
        for(let index in libs) {
            let script = libs[index];
            includeJS(script.href, script.onload);
        }

        
    };
    
</script>
<style>
    * {
        margin: 0;
        padding: 0;
    }

    html, body {
        height: 100%;
        width: 100%;
    }

    body {
        background-color: #333;
    }

    #canvas {
        left: 0;
        top: 0;
        position: fixed;
        width: 100%;
        height: 100%;
    }
 
</style>